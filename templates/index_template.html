<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cybersecurity News Feed</title>
  <style>
    :root {
      color-scheme: dark;
      --surface-primary: #0f172a;
      --surface-elevated: rgba(30, 41, 59, 0.85);
      --surface-border: rgba(148, 163, 184, 0.2);
      --surface-overlay: rgba(15, 23, 42, 0.8);
      --accent: #38bdf8;
      --accent-muted: rgba(56, 189, 248, 0.18);
      --accent-strong: rgba(56, 189, 248, 0.3);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-subtle: #64748b;
      --text-inverse: #0f172a;
      --font-base: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      --shadow-elevated: 0 24px 48px rgba(15, 23, 42, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.1), transparent 55%),
                  radial-gradient(circle at 80% -10%, rgba(99, 102, 241, 0.15), transparent 50%),
                  var(--surface-primary);
      color: var(--text-primary);
      font-family: var(--font-base);
      overflow: hidden;
    }

    header {
      padding: clamp(1.5rem, 3vw, 2.75rem) clamp(1.5rem, 4vw, 3.5rem) clamp(1rem, 2vw, 1.5rem);
    }

    .page-title {
      margin: 0;
      font-size: clamp(1.75rem, 3vw, 2.5rem);
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .page-subtitle {
      margin-top: 0.5rem;
      margin-bottom: 0;
      max-width: 72ch;
      color: var(--text-secondary);
      font-size: clamp(0.95rem, 1.4vw, 1.05rem);
      line-height: 1.6;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0 clamp(1.25rem, 3vw, 3.5rem) clamp(1.5rem, 3vw, 3rem);
      gap: clamp(1rem, 2vw, 1.5rem);
      min-height: 0;
    }

    .card-column__header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
    }

    .card-column__title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .card-column__count {
      font-size: 0.85rem;
      color: var(--text-subtle);
    }

    .board-tools {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.65));
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.4);
      border-radius: 22px;
      padding: clamp(1rem, 2.5vw, 1.75rem);
      display: flex;
      flex-direction: column;
      gap: clamp(1rem, 2vw, 1.5rem);
    }

    .filter-panel {
      display: grid;
      gap: clamp(1rem, 2vw, 1.5rem);
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .filter-panel__group {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .filter-panel__group--wide {
      grid-column: 1 / -1;
    }

    .filter-panel__label {
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .filter-panel__input,
    .filter-panel__select {
      width: 100%;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 14px;
      padding: 0.65rem 0.75rem;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-panel__input:focus,
    .filter-panel__select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25);
    }

    .filter-panel__hint {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-subtle);
    }

    .filter-panel__checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .filter-panel__checkbox {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.65rem;
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .filter-panel__checkbox input {
      accent-color: var(--accent);
    }

    .filter-panel__checkbox:hover,
    .filter-panel__checkbox:focus-within {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.14);
    }

    .filter-panel__checkboxes--toggles {
      flex-wrap: wrap;
      gap: 0.4rem 0.6rem;
    }

    .filter-toggle {
      font-size: 0.82rem;
      color: var(--text-secondary);
    }

    .filter-panel__actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .filter-panel__actions button {
      appearance: none;
      border: none;
      border-radius: 14px;
      padding: 0.6rem 1.1rem;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: var(--accent);
      color: var(--text-inverse);
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-panel__actions button:hover,
    .filter-panel__actions button:focus {
      outline: none;
      background: #0ea5e9;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25);
    }

    .card-board {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .card-board__columns {
      flex: 1;
      min-height: 0;
      display: flex;
      gap: clamp(1rem, 2vw, 1.5rem);
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 0.5rem;
      scroll-behavior: smooth;
    }

    .card-board__columns::-webkit-scrollbar {
      height: 10px;
    }

    .card-board__columns::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.35);
      border-radius: 999px;
    }

    .card-board__columns::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
    }

    .card-category {
      flex: 0 0 clamp(280px, 26vw, 360px);
      display: flex;
      flex-direction: column;
      min-height: 0;
      max-height: 100%;
      border-radius: 22px;
      border: 1px solid var(--surface-border);
      background: linear-gradient(165deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.85));
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
      overflow: hidden;
    }

    .card-category[hidden] {
      display: none;
    }

    .card-category__header {
      padding: 1rem 1.25rem 0.75rem;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.75rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
    }

    .card-category__title {
      margin: 0;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .card-category__count {
      font-size: 0.8rem;
      color: var(--text-subtle);
    }

    .card-list {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 1rem 1.25rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .card-list::-webkit-scrollbar {
      width: 10px;
    }

    .card-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.35);
      border-radius: 999px;
    }

    .card-list::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
    }

    .card-empty {
      margin: 0 auto;
      align-self: center;
      padding: 2.5rem;
      max-width: 32rem;
      text-align: center;
      border-radius: 18px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      color: var(--text-secondary);
      background: rgba(15, 23, 42, 0.55);
    }

    .feed-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem 1.1rem;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.25);
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .feed-card[hidden] {
      display: none;
    }

    .feed-card:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2), 0 20px 40px rgba(15, 23, 42, 0.45);
    }

    .feed-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
    }

    .feed-card--active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25), 0 26px 52px rgba(15, 23, 42, 0.45);
    }

    .feed-card__meta {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .feed-card__summary {
      margin: 0;
      font-size: clamp(0.92rem, 1.2vw, 1.05rem);
      line-height: 1.6;
      color: var(--text-primary);
    }

    .feed-card__footer {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem 0.6rem;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .feed-card__category {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.14);
      color: var(--accent);
      font-weight: 600;
      letter-spacing: 0.06em;
    }

    .feed-card__stat {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
    }

    .feed-card__stat--muted {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-subtle);
    }

    .feed-card__tagline {
      color: var(--accent);
      font-weight: 500;
    }

    .detail-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: clamp(1rem, 3vw, 2rem);
      z-index: 1000;
    }

    .detail-overlay.is-visible {
      display: flex;
    }

    .detail-overlay__backdrop {
      position: absolute;
      inset: 0;
      background: var(--surface-overlay);
      backdrop-filter: blur(6px);
    }

    .detail-overlay__panel {
      position: relative;
      width: min(960px, 90vw);
      max-height: min(85vh, 860px);
      background: linear-gradient(160deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.92));
      border-radius: 26px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: var(--shadow-elevated);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: var(--text-primary);
    }

    .detail-overlay__close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      border: none;
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-secondary);
      border-radius: 999px;
      font-size: 1.5rem;
      line-height: 1;
      width: 2.25rem;
      height: 2.25rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .detail-overlay__close:hover,
    .detail-overlay__close:focus {
      outline: none;
      background: rgba(56, 189, 248, 0.2);
      color: var(--accent);
    }

    .detail-overlay__body {
      flex: 1;
      overflow: auto;
      padding: clamp(1.5rem, 2.5vw, 2rem) clamp(1.5rem, 3vw, 2.5rem);
      display: flex;
      flex-direction: column;
      gap: clamp(1.25rem, 2vw, 1.75rem);
    }

    .detail-overlay__placeholder {
      margin: auto;
      max-width: 40ch;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .detail-overlay__content[hidden] {
      display: none;
    }

    .detail-panel__header {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: space-between;
      align-items: flex-start;
    }

    .detail-panel__meta {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .detail-panel__title {
      margin: 0;
      font-size: clamp(1.2rem, 2vw, 1.5rem);
      line-height: 1.3;
    }

    .detail-panel__meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .detail-panel__source-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .detail-panel__source-list li {
      padding: 0.35rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
    }

    .detail-panel__link {
      align-self: flex-start;
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      background: var(--accent);
      color: var(--text-inverse);
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-decoration: none;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .detail-panel__link:hover,
    .detail-panel__link:focus {
      outline: none;
      background: #0ea5e9;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25);
    }

    .detail-panel__section {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    .detail-panel__section h3,
    .detail-panel__section h2 {
      margin: 0;
      font-size: 0.92rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .detail-panel__text {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.7;
      white-space: pre-wrap;
      color: var(--text-primary);
    }

    .detail-panel__pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .detail-panel__pill {
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.12);
      color: var(--accent);
      font-size: 0.78rem;
      letter-spacing: 0.02em;
    }

    .detail-panel__empty {
      font-size: 0.82rem;
      color: var(--text-subtle);
      font-style: italic;
    }

    .detail-panel__cve-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .detail-panel__cve {
      padding: 0.75rem 0.85rem;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .detail-panel__cve-id {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text-primary);
    }

    .detail-panel__cve-meta,
    .detail-panel__cve-mitre {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .detail-panel__cve-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .detail-panel__cve-tag {
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.2);
      color: var(--accent);
      font-size: 0.75rem;
    }

    @media (max-width: 960px) {
      body {
        height: auto;
        overflow: auto;
      }

      main {
        padding: 0 clamp(1rem, 4vw, 1.75rem) clamp(1.5rem, 6vw, 2.5rem);
      }

      .card-board__columns {
        flex-direction: column;
        overflow-x: hidden;
        overflow-y: visible;
      }

      .card-category {
        flex: 1 1 auto;
        min-width: 0;
        max-width: none;
      }

      .card-list {
        max-height: none;
      }

      .detail-overlay__panel {
        width: min(100%, 600px);
        max-height: 90vh;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 class="page-title">Cybersecurity Intelligence Briefing</h1>
    <p class="page-subtitle">Review AI-powered digests of the latest security headlines. Select a card to surface detailed intelligence, enrichment artefacts, and original source material.</p>
  </header>
  <main>
    <section class="board-tools">
      <div class="card-column__header">
        <span class="card-column__title">AI summaries</span>
        <span class="card-column__count" data-count-label>{{article_count_label}}</span>
      </div>
      <form id="feed-filter-panel" class="filter-panel" autocomplete="off" aria-label="Feed filters">
        <div class="filter-panel__group filter-panel__group--wide">
          <label class="filter-panel__label" for="filter-search">Search</label>
          <input class="filter-panel__input" type="search" id="filter-search" name="search" placeholder="Search summaries, notes, actors…">
          <p class="filter-panel__hint">Supports tokens such as <code>source:</code>, <code>category:</code>, <code>tag:</code>, and <code>has:cves</code>.</p>
        </div>
        <div class="filter-panel__group">
          <span class="filter-panel__label">Categories</span>
          <div class="filter-panel__checkboxes">
            {{category_filter_markup}}
          </div>
        </div>
        <div class="filter-panel__group">
          <label class="filter-panel__label" for="filter-source">Sources</label>
          <select class="filter-panel__select" id="filter-source" name="source" multiple size="{{source_size}}">
            {{source_options}}
          </select>
          <p class="filter-panel__hint">Hold Ctrl/Cmd to select multiple sources.</p>
        </div>
        <div class="filter-panel__group">
          <span class="filter-panel__label">Data enrichment</span>
          <div class="filter-panel__checkboxes filter-panel__checkboxes--toggles">
            <label class="filter-toggle"><input type="checkbox" id="filter-has-cves"> CVEs only</label>
            <label class="filter-toggle"><input type="checkbox" id="filter-has-actors"> Threat actors only</label>
            <label class="filter-toggle"><input type="checkbox" id="filter-has-iocs"> IOCs only</label>
            <label class="filter-toggle"><input type="checkbox" id="filter-has-ttps"> TTPs only</label>
          </div>
        </div>
        <div class="filter-panel__group filter-panel__actions">
          <button type="button" id="filter-reset">Reset filters</button>
        </div>
      </form>
    </section>
    <section class="card-board" aria-label="Category columns">
      <div class="card-board__columns">
        {{cards_markup}}
      </div>
    </section>
  </main>
  <div class="detail-overlay" aria-hidden="true" hidden>
    <div class="detail-overlay__backdrop" data-detail-close></div>
    <div class="detail-overlay__panel" role="dialog" aria-modal="true">
      <button type="button" class="detail-overlay__close" data-detail-close aria-label="Close detail">&times;</button>
      <div class="detail-overlay__body">
        <div class="detail-overlay__placeholder">
          <p>Select a summary to explore enrichment data, indicators, and source material.</p>
        </div>
        <div class="detail-overlay__content" hidden>
          <div class="detail-panel__header">
            <div class="detail-panel__meta">
              <h2 class="detail-panel__title" data-detail="title"></h2>
              <div class="detail-panel__meta-row">
                <span class="detail-panel__source" data-detail="source"></span>
                <span class="detail-panel__date" data-detail="date"></span>
              </div>
              <ul class="detail-panel__source-list" data-detail="sources"></ul>
            </div>
            <a class="detail-panel__link" data-detail="article" target="_blank" rel="noopener noreferrer">Open original article</a>
          </div>
          <section class="detail-panel__section">
            <h2>AI summary</h2>
            <p class="detail-panel__text" data-detail="AI-Summary"></p>
          </section>
          <section class="detail-panel__section">
            <h3>Threat actors</h3>
            <div class="detail-panel__pill-list" data-detail="ThreatActors"></div>
          </section>
          <section class="detail-panel__section">
            <h3>Techniques &amp; procedures</h3>
            <div class="detail-panel__pill-list" data-detail="TTPs"></div>
          </section>
          <section class="detail-panel__section">
            <h3>Indicators of compromise</h3>
            <div class="detail-panel__pill-list" data-detail="iocs"></div>
          </section>
          <section class="detail-panel__section">
            <h3>CVEs</h3>
            <ul class="detail-panel__cve-list" data-detail="CVEs"></ul>
          </section>
          <section class="detail-panel__section">
            <h3>Analyst notes</h3>
            <p class="detail-panel__text" data-detail="notes"></p>
          </section>
        </div>
      </div>
    </div>
  </div>
  <script id="article-data" type="application/json">{{articles_json}}</script>
  <script>
  (function() {
    const dataNode = document.getElementById('article-data');
    if (!dataNode) {
      return;
    }

    let articles = [];
    try {
      articles = JSON.parse(dataNode.textContent || '[]');
    } catch (error) {
      console.error('Unable to parse article payload:', error);
      return;
    }

    const articleMap = new Map();
    articles.forEach((article, index) => {
      articleMap.set(String(index), article);
    });

    const boardColumns = document.querySelector('.card-board__columns');
    const cards = Array.from(document.querySelectorAll('.feed-card'));
    const columns = Array.from(document.querySelectorAll('.card-category'));
    const countLabel = document.querySelector('[data-count-label]');
    const filterForm = document.getElementById('feed-filter-panel');
    if (filterForm) {
      filterForm.addEventListener('submit', (event) => event.preventDefault());
    }

    const filters = {
      search: document.getElementById('filter-search'),
      categories: Array.from(document.querySelectorAll('input[name="category"]')),
      source: document.getElementById('filter-source'),
      cves: document.getElementById('filter-has-cves'),
      actors: document.getElementById('filter-has-actors'),
      iocs: document.getElementById('filter-has-iocs'),
      ttps: document.getElementById('filter-has-ttps')
    };
    const resetButton = document.getElementById('filter-reset');

    const overlay = document.querySelector('.detail-overlay');
    const overlayBackdrop = overlay ? overlay.querySelector('.detail-overlay__backdrop') : null;
    const overlayCloseButtons = overlay ? Array.from(overlay.querySelectorAll('[data-detail-close]')) : [];
    const overlayBody = overlay ? overlay.querySelector('.detail-overlay__body') : null;
    const overlayPlaceholder = overlayBody ? overlayBody.querySelector('.detail-overlay__placeholder') : null;
    const overlayContent = overlayBody ? overlayBody.querySelector('.detail-overlay__content') : null;
    const defaultPlaceholder = overlayPlaceholder ? overlayPlaceholder.innerHTML : '';

    const refs = overlay ? {
      title: overlay.querySelector('[data-detail="title"]'),
      source: overlay.querySelector('[data-detail="source"]'),
      date: overlay.querySelector('[data-detail="date"]'),
      link: overlay.querySelector('[data-detail="article"]'),
      sourceList: overlay.querySelector('[data-detail="sources"]'),
      summary: overlay.querySelector('[data-detail="AI-Summary"]'),
      notes: overlay.querySelector('[data-detail="notes"]'),
      iocs: overlay.querySelector('[data-detail="iocs"]'),
      ttps: overlay.querySelector('[data-detail="TTPs"]'),
      actors: overlay.querySelector('[data-detail="ThreatActors"]'),
      cves: overlay.querySelector('[data-detail="CVEs"]')
    } : {};

    function clearNode(node) {
      if (!node) {
        return;
      }
      while (node.firstChild) {
        node.removeChild(node.firstChild);
      }
    }

    function ensureArray(value) {
      if (Array.isArray(value)) {
        return value.filter((item) => item !== null && item !== undefined && item !== '');
      }
      if (value === null || value === undefined || value === '') {
        return [];
      }
      return [value];
    }

    function setText(node, value, fallback) {
      if (!node) {
        return;
      }
      const text = (value === null || value === undefined || value === '') ? fallback : value;
      node.textContent = text || fallback || '';
    }

    function setFullText(node, value, fallback) {
      if (!node) {
        return;
      }
      if (value === null || value === undefined || value === '') {
        node.textContent = fallback || '';
      } else {
        node.textContent = value;
      }
    }

    function renderSources(container, values) {
      if (!container) {
        return;
      }
      clearNode(container);
      const items = ensureArray(values);
      if (!items.length) {
        return;
      }
      items.forEach((entry) => {
        const item = document.createElement('li');
        if (typeof entry === 'string') {
          item.textContent = entry;
        } else if (entry && typeof entry === 'object') {
          const name = entry.name || entry.label || '';
          const url = entry.url;
          if (url) {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = name || url;
            item.appendChild(link);
          } else {
            item.textContent = name || '';
          }
        }
        container.appendChild(item);
      });
    }

    function createPill(text) {
      const pill = document.createElement('span');
      pill.className = 'detail-panel__pill';
      pill.textContent = text;
      return pill;
    }

    function renderPills(container, values, emptyLabel) {
      if (!container) {
        return;
      }
      clearNode(container);
      const items = ensureArray(values);
      if (!items.length) {
        const empty = document.createElement('span');
        empty.className = 'detail-panel__empty';
        empty.textContent = emptyLabel;
        container.appendChild(empty);
        return;
      }
      items.forEach((item) => {
        if (item && typeof item === 'object' && !Array.isArray(item)) {
          const text = Object.values(item).join(' · ');
          container.appendChild(createPill(text));
        } else {
          container.appendChild(createPill(String(item)));
        }
      });
    }

    function renderCves(container, values) {
      if (!container) {
        return;
      }
      clearNode(container);
      const items = ensureArray(values);
      if (!items.length) {
        const empty = document.createElement('li');
        empty.className = 'detail-panel__empty';
        empty.textContent = 'No CVEs reported.';
        container.appendChild(empty);
        return;
      }
      items.forEach((entry) => {
        const item = document.createElement('li');
        item.className = 'detail-panel__cve';
        const id = document.createElement('div');
        id.className = 'detail-panel__cve-id';
        id.textContent = entry.cve || 'Unknown CVE';
        item.appendChild(id);
        const meta = document.createElement('div');
        meta.className = 'detail-panel__cve-meta';
        const cvss = (entry.cvss !== null && entry.cvss !== undefined) ? `CVSS ${entry.cvss}` : null;
        const stage = entry.weaponization_stage || null;
        const exploited = entry.exploited ? 'Exploited' : null;
        const tags = [cvss, stage, exploited].filter(Boolean);
        if (tags.length) {
          meta.textContent = tags.join(' · ');
          item.appendChild(meta);
        }
        const mitre = ensureArray(entry.mapped_mitre_ids);
        if (mitre.length) {
          const mitreLine = document.createElement('div');
          mitreLine.className = 'detail-panel__cve-mitre';
          mitreLine.textContent = mitre.join(', ');
          item.appendChild(mitreLine);
        }
        const extraTags = ensureArray(entry.yara).concat(ensureArray(entry.sigma));
        if (extraTags.length) {
          const tagList = document.createElement('div');
          tagList.className = 'detail-panel__cve-tags';
          extraTags.forEach((tag) => {
            const tagNode = document.createElement('span');
            tagNode.className = 'detail-panel__cve-tag';
            tagNode.textContent = tag;
            tagList.appendChild(tagNode);
          });
          item.appendChild(tagList);
        }
        container.appendChild(item);
      });
    }

    function populateDetail(article) {
      if (!overlay || !overlayContent || !overlayPlaceholder) {
        return;
      }
      overlayPlaceholder.hidden = true;
      overlayContent.hidden = false;

      const sourceEntries = ensureArray(article.sources);
      const sourceNames = sourceEntries.map((entry) => {
        if (!entry) {
          return '';
        }
        if (typeof entry === 'string') {
          return entry;
        }
        return entry.name || entry.label || '';
      }).filter(Boolean);
      const primarySource = sourceNames.length ? sourceNames.join(', ') : (article.source || '');

      setText(refs.title, article.title || '', 'Untitled');
      setText(refs.source, primarySource || 'Unknown source', 'Unknown source');
      setText(refs.date, article.date || '', 'Date unavailable');
      renderSources(refs.sourceList, sourceEntries);

      if (refs.link) {
        const sourceUrl = article.article || (sourceEntries.find((entry) => entry && entry.url)?.url) || '';
        if (sourceUrl) {
          refs.link.href = sourceUrl;
          refs.link.classList.remove('is-disabled');
          refs.link.textContent = 'Open original article';
        } else {
          refs.link.removeAttribute('href');
          refs.link.classList.add('is-disabled');
          refs.link.textContent = 'Link unavailable';
        }
      }

      setFullText(refs.summary, article['AI-Summary'], 'No AI summary available.');
      setFullText(refs.notes, article.notes, 'No analyst notes provided.');
      renderPills(refs.actors, article.ThreatActors, 'No threat actors identified.');
      renderPills(refs.ttps, article.TTPs, 'No tactics or techniques listed.');
      renderPills(refs.iocs, article.iocs, 'No indicators extracted.');
      renderCves(refs.cves, article.CVEs);
    }

    let activeCard = null;

    function openOverlay(card) {
      if (!overlay || !card) {
        return;
      }
      const article = articleMap.get(card.dataset.index);
      if (!article) {
        return;
      }
      if (activeCard && activeCard !== card) {
        activeCard.classList.remove('feed-card--active');
      }
      activeCard = card;
      card.classList.add('feed-card--active');
      overlay.hidden = false;
      overlay.classList.add('is-visible');
      overlay.setAttribute('aria-hidden', 'false');
      populateDetail(article);
    }

    function hideOverlay() {
      if (!overlay) {
        return;
      }
      overlay.classList.remove('is-visible');
      overlay.setAttribute('aria-hidden', 'true');
      overlay.hidden = true;
      if (overlayPlaceholder) {
        overlayPlaceholder.hidden = false;
        overlayPlaceholder.innerHTML = defaultPlaceholder;
      }
      if (overlayContent) {
        overlayContent.hidden = true;
      }
      if (activeCard) {
        activeCard.classList.remove('feed-card--active');
        activeCard = null;
      }
    }

    overlayCloseButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        hideOverlay();
      });
    });

    if (overlayBackdrop) {
      overlayBackdrop.addEventListener('click', hideOverlay);
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && overlay && !overlay.hidden) {
        hideOverlay();
      }
    });

    function focusCard(card, behavior) {
      if (!card) {
        return;
      }
      const columnList = card.closest('.card-list');
      if (columnList) {
        const targetTop = card.offsetTop - (columnList.clientHeight / 2) + (card.clientHeight / 2);
        const top = Number.isFinite(targetTop) ? Math.max(0, targetTop) : 0;
        if (typeof columnList.scrollTo === 'function') {
          columnList.scrollTo({ top, behavior: behavior || 'smooth' });
        } else {
          columnList.scrollTop = top;
        }
      }
      if (boardColumns) {
        const column = card.closest('.card-category');
        if (column) {
          const left = column.offsetLeft - (boardColumns.clientWidth - column.offsetWidth) / 2;
          const clamped = Number.isFinite(left) ? Math.max(0, Math.min(left, boardColumns.scrollWidth)) : 0;
          if (typeof boardColumns.scrollTo === 'function') {
            boardColumns.scrollTo({ left: clamped, behavior: behavior || 'smooth' });
          } else {
            boardColumns.scrollLeft = clamped;
          }
        }
      }
    }

    if (boardColumns) {
      boardColumns.addEventListener('wheel', (event) => {
        if (Math.abs(event.deltaY) > Math.abs(event.deltaX)) {
          boardColumns.scrollBy({ left: event.deltaY, behavior: 'auto' });
          event.preventDefault();
        }
      }, { passive: false });
    }

    function parseQuery(raw) {
      const result = { text: '', source: [], tag: [], category: [], has: [] };
      if (!raw) {
        return result;
      }
      let working = raw;
      const pattern = /\b(source|tag|category|has):(?:"([^"]+)"|(\S+))/gi;
      working = working.replace(pattern, (_, key, quoted, unquoted) => {
        const value = (quoted || unquoted || '').trim().toLowerCase();
        if (value) {
          result[key.toLowerCase()].push(value);
        }
        return ' ';
      });
      result.text = working.trim().toLowerCase();
      return result;
    }

    function applyFilters() {
      const query = parseQuery(filters.search ? filters.search.value : '');
      const selectedSources = filters.source ? Array.from(filters.source.selectedOptions).map((option) => option.value.toLowerCase()) : [];
      const activeCategories = filters.categories.filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);
      const toggles = {
        cves: filters.cves ? filters.cves.checked : false,
        actors: filters.actors ? filters.actors.checked : false,
        iocs: filters.iocs ? filters.iocs.checked : false,
        ttps: filters.ttps ? filters.ttps.checked : false
      };

      let visibleCount = 0;
      let firstVisible = null;

      cards.forEach((card) => {
        let visible = true;
        const categories = (card.dataset.categories || '').split(/\s+/).filter(Boolean);
        const categoryLabels = (card.dataset.categoryLabels || '').toLowerCase();
        const sourceValues = (card.dataset.source || '').toLowerCase().split('|').filter(Boolean);
        const tags = (card.dataset.tags || '').toLowerCase();
        const searchBlob = (card.dataset.search || '').toLowerCase();

        if (activeCategories.length && !categories.some((slug) => activeCategories.includes(slug))) {
          visible = false;
        }
        if (visible && toggles.cves && card.dataset.hasCves !== 'true') {
          visible = false;
        }
        if (visible && toggles.actors && card.dataset.hasActors !== 'true') {
          visible = false;
        }
        if (visible && toggles.iocs && card.dataset.hasIocs !== 'true') {
          visible = false;
        }
        if (visible && toggles.ttps && card.dataset.hasTtps !== 'true') {
          visible = false;
        }
        if (visible && selectedSources.length && !sourceValues.some((src) => selectedSources.includes(src))) {
          visible = false;
        }
        if (visible && query.text && !searchBlob.includes(query.text)) {
          visible = false;
        }
        if (visible && query.source.length && !query.source.every((token) => sourceValues.some((src) => src.includes(token)))) {
          visible = false;
        }
        if (visible && query.tag.length && !query.tag.every((token) => tags.includes(token))) {
          visible = false;
        }
        if (visible && query.category.length) {
          const matchesCategory = query.category.every((token) => {
            return categories.some((slug) => slug.includes(token)) || categoryLabels.includes(token);
          });
          if (!matchesCategory) {
            visible = false;
          }
        }
        if (visible && query.has.length) {
          const hasMap = {
            cves: card.dataset.hasCves === 'true',
            actors: card.dataset.hasActors === 'true',
            iocs: card.dataset.hasIocs === 'true',
            ttps: card.dataset.hasTtps === 'true'
          };
          const hasOk = query.has.every((token) => {
            const key = token.replace(/s$/, '');
            if (token === 'cves') {
              return hasMap.cves;
            }
            if (token === 'actors') {
              return hasMap.actors;
            }
            if (token === 'iocs') {
              return hasMap.iocs;
            }
            if (token === 'ttps') {
              return hasMap.ttps;
            }
            return hasMap[key];
          });
          if (!hasOk) {
            visible = false;
          }
        }

        if (visible) {
          card.hidden = false;
          card.classList.remove('feed-card--hidden');
          if (!firstVisible) {
            firstVisible = card;
          }
          visibleCount += 1;
        } else {
          card.hidden = true;
          card.classList.add('feed-card--hidden');
          if (activeCard === card) {
            hideOverlay();
          }
        }
      });

      columns.forEach((column) => {
        const columnCards = Array.from(column.querySelectorAll('.feed-card'));
        const columnVisible = columnCards.filter((card) => !card.hidden).length;
        column.toggleAttribute('hidden', columnVisible === 0);
        const countNode = column.querySelector('.card-category__count');
        if (countNode) {
          countNode.textContent = `${columnVisible} item${columnVisible === 1 ? '' : 's'}`;
        }
      });

      if (countLabel) {
        countLabel.textContent = `${visibleCount} item${visibleCount === 1 ? '' : 's'}`;
      }

      const shouldFocus = Boolean(query.text || query.source.length || query.tag.length || query.category.length || selectedSources.length);
      if (shouldFocus && firstVisible) {
        focusCard(firstVisible, 'auto');
      }
    }

    const filterInputs = [
      filters.search,
      filters.source,
      filters.cves,
      filters.actors,
      filters.iocs,
      filters.ttps,
      ...filters.categories
    ].filter(Boolean);

    filterInputs.forEach((input) => {
      const eventName = input === filters.search ? 'input' : 'change';
      input.addEventListener(eventName, () => applyFilters());
    });

    if (resetButton) {
      resetButton.addEventListener('click', () => {
        if (filters.search) {
          filters.search.value = '';
        }
        if (filters.source) {
          Array.from(filters.source.options).forEach((option) => {
            option.selected = false;
          });
        }
        filters.categories.forEach((checkbox) => {
          checkbox.checked = true;
        });
        if (filters.cves) filters.cves.checked = false;
        if (filters.actors) filters.actors.checked = false;
        if (filters.iocs) filters.iocs.checked = false;
        if (filters.ttps) filters.ttps.checked = false;
        applyFilters();
      });
    }

    cards.forEach((card) => {
      card.addEventListener('click', () => {
        openOverlay(card);
        focusCard(card, 'smooth');
      });
      card.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          openOverlay(card);
          focusCard(card, 'smooth');
        }
      });
    });

    applyFilters();
  })();
  </script>
</body>
</html>
